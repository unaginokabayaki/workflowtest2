name: Deploy Flask App to Cloud test

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'ãƒ‡ãƒ—ãƒ­ã‚¤ç’°å¢ƒã‚’é¸æŠ'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production
      deploy_message:
        description: 'ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)'
        required: false
        type: string

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GAR_LOCATION: asia-northeast2 # Google Artifact Registry location
  SERVICE: flask-workflowtest2-${{ github.event.inputs.environment }} # ç’°å¢ƒåˆ¥ã®ã‚µãƒ¼ãƒ“ã‚¹å
  REGION: asia-northeast2 # Cloud Run region

jobs:
  deploy:
    # Workload Identity Federationã«å¿…è¦ãªæ¨©é™
    permissions:
      contents: read      # ãƒªãƒã‚¸ãƒˆãƒªã®å†…å®¹ã‚’èª­ã¿å–ã‚Š
      id-token: write     # OIDC ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆã—ã¦å¤–éƒ¨èªè¨¼ã«ä½¿ç”¨

    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4  # ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ

      - name: ãƒ‡ãƒ—ãƒ­ã‚¤æƒ…å ±ã‚’è¡¨ç¤º
        run: |
          echo "ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤é–‹å§‹"
          echo "ç’°å¢ƒ: ${{ github.event.inputs.environment }}"
          echo "ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref_name }}"
          echo "ã‚³ãƒŸãƒƒãƒˆ: ${{ github.sha }}"
          if [ "${{ github.event.inputs.deploy_message }}" != "" ]; then
            echo "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ${{ github.event.inputs.deploy_message }}"
          fi

      - name: Google Auth
        id: auth
        uses: 'google-github-actions/auth@v2'  # GCPã®èªè¨¼ã‚’å®Ÿæ–½
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}  # Workload Identity Provider
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}      # ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹

      - name: Set up Cloud SDK
        uses: 'google-github-actions/setup-gcloud@v2'

      - name: Configure Docker to use gcloud as a credential helper
        run: |-
          gcloud auth configure-docker ${{ env.GAR_LOCATION }}-docker.pkg.dev

      # Step 1: èªè¨¼ãƒ†ã‚¹ãƒˆ
      - name: ãƒ†ã‚¹ãƒˆ - åŸºæœ¬èªè¨¼
        run: |
          gcloud auth list
          gcloud projects list --limit=1

      # Step 2: Artifact Registryæ¥ç¶šãƒ†ã‚¹ãƒˆ  
      - name: ãƒ†ã‚¹ãƒˆ - Artifact Registry
        run: |
          gcloud artifacts repositories list --location=${{ env.GAR_LOCATION }}

      # Step 3: Dockerèªè¨¼ãƒ†ã‚¹ãƒˆ
      - name: ãƒ†ã‚¹ãƒˆ - Dockerèªè¨¼
        run: |
          echo "test" | docker login -u oauth2accesstoken --password-stdin https://${{ env.GAR_LOCATION }}-docker.pkg.dev